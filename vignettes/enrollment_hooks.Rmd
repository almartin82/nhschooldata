---
title: "Exploring New Hampshire School Enrollment Data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Exploring New Hampshire School Enrollment Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 8,
  fig.height = 5,
  warning = FALSE,
  message = FALSE,
  cache = TRUE
)
```

## Data Access Note

The NH DOE iPlatform requires browser-based access. If automatic download fails:

1. Visit [my.doe.nh.gov/iPlatform](https://my.doe.nh.gov/iPlatform)
2. Download the enrollment reports
3. Use `import_local_enrollment()` to load the data

```{r load-packages}
library(nhschooldata)
library(dplyr)
library(tidyr)
library(ggplot2)
theme_set(theme_minimal(base_size = 14))
```

### 1. New Hampshire serves roughly 165,000 public school students

Despite being one of the smallest states, New Hampshire maintains a robust public education system. Tracking statewide totals reveals how enrollment has shifted over the past decade.

```{r statewide-data}
enr <- fetch_enr_multi(2016:2024, use_cache = TRUE)

statewide <- enr %>%
  filter(is_state, subgroup == "total_enrollment", grade_level == "TOTAL") %>%
  select(end_year, n_students)

statewide
```

```{r statewide-chart, fig.cap="New Hampshire statewide enrollment 2016-2024"}
ggplot(statewide, aes(x = end_year, y = n_students)) +
  geom_line(color = "#2E86AB", linewidth = 1.2) +
  geom_point(color = "#2E86AB", size = 3) +
  scale_y_continuous(labels = scales::comma, limits = c(0, NA)) +
  labs(
    title = "New Hampshire Public School Enrollment (2016-2024)",
    subtitle = "Statewide total enrollment over time",
    x = "Year",
    y = "Students"
  )
```

### 2. Manchester is New Hampshire's school giant

Manchester School District is the state's largest by a wide margin, serving more students than any other district in the Granite State. Here are the top 10 districts by enrollment.

```{r top-districts-data}
enr_2024 <- fetch_enr(2024, use_cache = TRUE)

top_districts <- enr_2024 %>%
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL") %>%
  arrange(desc(n_students)) %>%
  head(10) %>%
  select(district_name, n_students)

top_districts
```

```{r top-districts-chart, fig.cap="Top 10 New Hampshire school districts by enrollment"}
top_districts %>%
  mutate(district_name = gsub(" School District", "", district_name)) %>%
  mutate(district_name = factor(district_name, levels = rev(district_name))) %>%
  ggplot(aes(x = n_students, y = district_name)) +
  geom_col(fill = "#2E86AB") +
  geom_text(aes(label = scales::comma(n_students)), hjust = -0.1, size = 3.5) +
  scale_x_continuous(labels = scales::comma, expand = expansion(mult = c(0, 0.15))) +
  labs(
    title = "Largest School Districts in New Hampshire (2024)",
    x = "Students",
    y = NULL
  )
```

### 3. Manchester and Nashua together enroll a significant share of the state

New Hampshire's two largest cities -- Manchester and Nashua -- combined account for a disproportionate share of the state's public school students. Tracking their combined share over time shows how concentrated enrollment is.

```{r big-cities-data}
big_cities <- enr %>%
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         grepl("Manchester|Nashua", district_name)) %>%
  group_by(end_year) %>%
  summarize(combined = sum(n_students, na.rm = TRUE), .groups = "drop")

state_totals <- enr %>%
  filter(is_state, subgroup == "total_enrollment", grade_level == "TOTAL") %>%
  select(end_year, state_total = n_students)

big_cities %>%
  left_join(state_totals, by = "end_year") %>%
  mutate(pct_of_state = round(combined / state_total * 100, 1))
```

### 4. New Hampshire is becoming more diverse

New Hampshire is one of the whitest states in America, but its student demographics are shifting. Hispanic, Asian, and multiracial populations have been growing as a share of total enrollment.

```{r demographics-data}
enr_demo <- fetch_enr_multi(c(2016, 2018, 2020, 2024), use_cache = TRUE)

demographics <- enr_demo %>%
  filter(is_state, grade_level == "TOTAL",
         subgroup %in% c("white", "hispanic", "asian", "black", "multiracial")) %>%
  group_by(end_year) %>%
  mutate(pct = n_students / sum(n_students) * 100) %>%
  ungroup() %>%
  select(end_year, subgroup, pct)

demographics_wide <- demographics %>%
  pivot_wider(names_from = subgroup, values_from = pct)

demographics_wide
```

```{r demographics-chart, fig.cap="Demographic shifts in New Hampshire schools"}
demographics %>%
  mutate(subgroup = factor(subgroup,
                           levels = c("white", "hispanic", "asian", "multiracial", "black"),
                           labels = c("White", "Hispanic", "Asian", "Multiracial", "Black"))) %>%
  ggplot(aes(x = end_year, y = pct, color = subgroup)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 3) +
  scale_color_manual(values = c("White" = "#2E86AB", "Hispanic" = "#E94F37",
                                "Asian" = "#F6AE2D", "Multiracial" = "#86BA90",
                                "Black" = "#A23B72")) +
  scale_y_continuous(labels = function(x) paste0(x, "%")) +
  labs(
    title = "Demographic Composition of NH Public Schools (2016-2024)",
    x = "Year",
    y = "Percent of Students",
    color = "Group"
  ) +
  theme(legend.position = "right")
```

### 5. The Seacoast grows while the North Country empties out

New Hampshire's geography creates a stark enrollment divide. Seacoast communities like Portsmouth, Dover, and Exeter attract families, while North Country districts in Berlin, Colebrook, and Gorham face declining populations as young people leave.

```{r regional-data}
seacoast <- c("Portsmouth", "Dover", "Rochester", "Exeter", "Hampton")
north_country <- c("Berlin", "Colebrook", "Lancaster", "Littleton", "Gorham")

enr_regional <- fetch_enr_multi(c(2016, 2018, 2021, 2024), use_cache = TRUE)

regional <- enr_regional %>%
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL") %>%
  mutate(region = case_when(
    grepl(paste(seacoast, collapse = "|"), district_name) ~ "Seacoast",
    grepl(paste(north_country, collapse = "|"), district_name) ~ "North Country",
    TRUE ~ "Other"
  )) %>%
  filter(region %in% c("Seacoast", "North Country")) %>%
  group_by(end_year, region) %>%
  summarize(total = sum(n_students, na.rm = TRUE), .groups = "drop")

regional
```

```{r regional-chart, fig.cap="Regional enrollment trends in New Hampshire"}
ggplot(regional, aes(x = end_year, y = total, color = region)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 3) +
  scale_color_manual(values = c("Seacoast" = "#2E86AB", "North Country" = "#E94F37")) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "Regional Enrollment: Seacoast vs. North Country",
    subtitle = "Diverging fortunes across New Hampshire",
    x = "Year",
    y = "Students",
    color = "Region"
  ) +
  theme(legend.position = "right")
```

### 6. Kindergarten enrollment signals what is coming for NH schools

Kindergarten enrollment is a leading indicator for future school enrollment. Year-over-year changes in kindergarten classes ripple through the system for the next 12 years.

```{r kindergarten-data}
kindergarten <- enr %>%
  filter(is_state, subgroup == "total_enrollment", grade_level == "K") %>%
  select(end_year, k_students = n_students)

# Calculate year-over-year change
kindergarten %>%
  mutate(
    change = k_students - lag(k_students),
    pct_change = round(change / lag(k_students) * 100, 1)
  )
```

### 7. Grade-level enrollment reveals the student pipeline

Tracking key grade milestones -- kindergarten entry, 5th grade, 9th grade, and 12th grade graduation -- shows how cohorts shrink or grow as they move through the system.

```{r grade-level-data}
enr_grades <- fetch_enr_multi(2016:2024, use_cache = TRUE)

grades <- enr_grades %>%
  filter(is_state, subgroup == "total_enrollment",
         grade_level %in% c("K", "01", "05", "09", "12")) %>%
  select(end_year, grade_level, n_students) %>%
  mutate(grade_label = case_when(
    grade_level == "K" ~ "Kindergarten",
    grade_level == "01" ~ "1st Grade",
    grade_level == "05" ~ "5th Grade",
    grade_level == "09" ~ "9th Grade",
    grade_level == "12" ~ "12th Grade"
  ))

grades
```

```{r grade-level-chart, fig.cap="Enrollment by grade level over time"}
grades %>%
  mutate(grade_label = factor(grade_label,
                              levels = c("Kindergarten", "1st Grade", "5th Grade",
                                         "9th Grade", "12th Grade"))) %>%
  ggplot(aes(x = end_year, y = n_students, color = grade_label)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  scale_color_brewer(palette = "Set1") +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "New Hampshire Enrollment by Grade Level (2016-2024)",
    x = "Year",
    y = "Students",
    color = "Grade"
  ) +
  theme(legend.position = "right")
```

### 8. Most NH districts are tiny -- shared SAUs hold the system together

New Hampshire has a fragmented district landscape. Most districts enroll fewer than 300 students and depend on School Administrative Units (SAUs) to share superintendents and central office staff.

```{r district-size-data}
district_sizes <- enr_2024 %>%
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL") %>%
  mutate(size = case_when(
    n_students >= 3000 ~ "Large (3,000+)",
    n_students >= 1000 ~ "Medium (1,000-2,999)",
    n_students >= 300 ~ "Small (300-999)",
    TRUE ~ "Tiny (<300)"
  )) %>%
  count(size) %>%
  mutate(size = factor(size, levels = c("Tiny (<300)", "Small (300-999)",
                                         "Medium (1,000-2,999)", "Large (3,000+)")))

district_sizes
```

```{r district-size-chart, fig.cap="Distribution of district sizes in New Hampshire"}
ggplot(district_sizes, aes(x = size, y = n, fill = size)) +
  geom_col() +
  geom_text(aes(label = n), vjust = -0.5, size = 4) +
  scale_fill_manual(values = c("Tiny (<300)" = "#E94F37", "Small (300-999)" = "#F6AE2D",
                               "Medium (1,000-2,999)" = "#86BA90", "Large (3,000+)" = "#2E86AB")) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1))) +
  labs(
    title = "New Hampshire Districts by Size (2024)",
    subtitle = "Most districts serve fewer than 300 students",
    x = "District Size",
    y = "Number of Districts"
  ) +
  theme(legend.position = "none")
```

### 9. The smallest districts in NH have fewer students than a single classroom

Some New Hampshire districts enroll so few students that they barely fill one classroom per grade. These micro-districts survive through SAU partnerships and regional school agreements.

```{r tiny-districts-data}
tiny_districts <- enr_2024 %>%
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         n_students < 200) %>%
  arrange(n_students) %>%
  head(10) %>%
  select(district_name, n_students)

tiny_districts
```

### 10. High school enrollment tracks the graduating pipeline

Following grades 9-12 over time shows how many students are in the graduation pipeline. Changes here directly affect workforce readiness and college enrollment across the state.

```{r high-school-data}
high_school <- enr %>%
  filter(is_state, subgroup == "total_enrollment",
         grade_level %in% c("09", "10", "11", "12")) %>%
  group_by(end_year) %>%
  summarize(hs_total = sum(n_students, na.rm = TRUE), .groups = "drop")

high_school
```

### 11. Elementary outnumbers secondary -- but by how much?

The balance between elementary (K-5) and secondary (6-12) enrollment affects staffing, facility planning, and per-pupil spending across the state.

```{r elem-sec-data}
elem_grades <- c("K", "01", "02", "03", "04", "05")
sec_grades <- c("06", "07", "08", "09", "10", "11", "12")

level_comparison <- enr %>%
  filter(is_state, subgroup == "total_enrollment") %>%
  mutate(level = case_when(
    grade_level %in% elem_grades ~ "Elementary",
    grade_level %in% sec_grades ~ "Secondary",
    TRUE ~ NA_character_
  )) %>%
  filter(!is.na(level)) %>%
  group_by(end_year, level) %>%
  summarize(students = sum(n_students, na.rm = TRUE), .groups = "drop")

level_comparison
```

### 12. Which districts are growing the fastest?

While overall enrollment trends get the headlines, individual districts tell different stories. Some communities are booming with new housing development while others bleed students year after year.

```{r growth-data}
growth <- enr %>%
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         end_year %in% c(2016, 2024)) %>%
  select(district_name, end_year, n_students) %>%
  pivot_wider(names_from = end_year, values_from = n_students,
                     names_prefix = "y")

# Calculate growth if data exists
if (nrow(growth) > 0 && "y2024" %in% names(growth) && "y2016" %in% names(growth)) {
  growth <- growth %>%
    mutate(
      change = y2024 - y2016,
      pct_change = round(change / y2016 * 100, 1)
    ) %>%
    arrange(desc(pct_change)) %>%
    head(10)
}

growth
```

### 13. Middle grades (6-8) carry the demographic wave

Middle school enrollment changes lag elementary shifts by about 5 years. Watching grades 6-8 reveals what happened to kindergarten classes half a decade ago.

```{r middle-grades-data}
middle_grades <- enr %>%
  filter(is_state, subgroup == "total_enrollment",
         grade_level %in% c("06", "07", "08")) %>%
  group_by(end_year) %>%
  summarize(middle_total = sum(n_students, na.rm = TRUE), .groups = "drop")

middle_grades
```

### 14. How many schools does each district operate?

Large districts run dozens of schools while tiny districts may have just one. The ratio of students to schools reveals which districts achieve economies of scale and which spread thin.

```{r school-counts-data}
school_counts <- enr_2024 %>%
  filter(is_campus, subgroup == "total_enrollment", grade_level == "TOTAL") %>%
  group_by(district_name) %>%
  summarize(n_schools = n(), .groups = "drop")

district_enrollment <- enr_2024 %>%
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL") %>%
  select(district_name, district_enrollment = n_students)

school_counts %>%
  left_join(district_enrollment, by = "district_name") %>%
  mutate(avg_school_size = round(district_enrollment / n_schools, 0)) %>%
  arrange(desc(n_schools)) %>%
  head(10)
```

### 15. Year-over-year enrollment changes reveal boom and bust cycles

Annual enrollment changes at the state level show whether New Hampshire is gaining or losing students. Even small percentage changes compound over time into major shifts for school budgets and staffing.

```{r state-changes-data}
state_changes <- enr %>%
  filter(is_state, subgroup == "total_enrollment", grade_level == "TOTAL") %>%
  arrange(end_year) %>%
  mutate(
    change = n_students - lag(n_students),
    pct_change = round(change / lag(n_students) * 100, 2)
  ) %>%
  select(end_year, n_students, change, pct_change)

state_changes
```

## Session Info

```{r session-info}
sessionInfo()
```
