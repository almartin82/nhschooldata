---
title: "10 Insights from New Hampshire School Enrollment Data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{10 Insights from New Hampshire School Enrollment Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 8,
  fig.height = 5,
  warning = FALSE,
  message = FALSE,
  cache = TRUE
)
```

## Note: Data Access

The NH DOE iPlatform requires browser-based access. To run this vignette with real data:

1. Visit https://my.doe.nh.gov/iPlatform
2. Download the enrollment reports
3. Use `import_local_enrollment()` to load the data

The code examples below show how to analyze the data once loaded.

```{r load-packages}
library(nhschooldata)
library(dplyr)
library(tidyr)
library(ggplot2)
theme_set(theme_minimal(base_size = 14))
```

## New Hampshire Enrollment Trends (2016-2024)

New Hampshire's public school enrollment reflects the state's demographic challenges - an aging population and declining birth rates leading to gradual enrollment decline.

```{r statewide-data}
enr <- fetch_enr_multi(2016:2024, use_cache = TRUE)

statewide <- enr %>%
  filter(is_state, subgroup == "total_enrollment", grade_level == "TOTAL") %>%
  select(end_year, n_students)

statewide
```

```{r statewide-chart, fig.cap="New Hampshire statewide enrollment 2016-2024"}
ggplot(statewide, aes(x = end_year, y = n_students)) +
  geom_line(color = "#2E86AB", linewidth = 1.2) +
  geom_point(color = "#2E86AB", size = 3) +
  scale_y_continuous(labels = scales::comma, limits = c(0, NA)) +
  labs(
    title = "New Hampshire Public School Enrollment (2016-2024)",
    subtitle = "Gradual decline reflecting demographic trends",
    x = "Year",
    y = "Students"
  )
```

## Top Districts: Manchester Leads, But Suburbs Grow

Manchester remains the largest district, but suburban communities like Bedford are gaining while urban centers shrink.

```{r top-districts-data}
enr_2024 <- fetch_enr(2024, use_cache = TRUE)

top_districts <- enr_2024 %>%
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL") %>%
  arrange(desc(n_students)) %>%
  head(10) %>%
  select(district_name, n_students)

top_districts
```

```{r top-districts-chart, fig.cap="Top 10 New Hampshire school districts by enrollment"}
top_districts %>%
  mutate(district_name = gsub(" School District", "", district_name)) %>%
  mutate(district_name = factor(district_name, levels = rev(district_name))) %>%
  ggplot(aes(x = n_students, y = district_name)) +
  geom_col(fill = "#2E86AB") +
  geom_text(aes(label = scales::comma(n_students)), hjust = -0.1, size = 3.5) +
  scale_x_continuous(labels = scales::comma, expand = expansion(mult = c(0, 0.15))) +
  labs(
    title = "Largest School Districts in New Hampshire (2024)",
    subtitle = "Manchester and Nashua together serve 13% of state students",
    x = "Students",
    y = NULL
  )
```

## Demographics: New Hampshire Is Getting More Diverse

Hispanic and multiracial students are among the fastest-growing demographic groups.

```{r demographics-data}
enr_demo <- fetch_enr_multi(c(2016, 2018, 2020, 2024), use_cache = TRUE)

demographics <- enr_demo %>%
  filter(is_state, grade_level == "TOTAL",
         subgroup %in% c("white", "hispanic", "asian", "black", "multiracial")) %>%
  group_by(end_year) %>%
  mutate(pct = n_students / sum(n_students) * 100) %>%
  ungroup() %>%
  select(end_year, subgroup, pct)

demographics_wide <- demographics %>%
  pivot_wider(names_from = subgroup, values_from = pct)

demographics_wide
```

```{r demographics-chart, fig.cap="Demographic shifts in New Hampshire schools"}
demographics %>%
  mutate(subgroup = factor(subgroup,
                           levels = c("white", "hispanic", "asian", "multiracial", "black"),
                           labels = c("White", "Hispanic", "Asian", "Multiracial", "Black"))) %>%
  ggplot(aes(x = end_year, y = pct, color = subgroup)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 3) +
  scale_color_manual(values = c("White" = "#2E86AB", "Hispanic" = "#E94F37",
                                "Asian" = "#F6AE2D", "Multiracial" = "#86BA90",
                                "Black" = "#A23B72")) +
  scale_y_continuous(labels = function(x) paste0(x, "%")) +
  labs(
    title = "Demographic Composition of NH Public Schools (2016-2024)",
    subtitle = "Hispanic and multiracial populations growing",
    x = "Year",
    y = "Percent of Students",
    color = "Group"
  ) +
  theme(legend.position = "right")
```

## Regional Divergence: Seacoast Steady, North Country Declining

Coastal communities are holding relatively steady while the North Country has experienced steeper declines.

```{r regional-data}
seacoast <- c("Portsmouth", "Dover", "Rochester", "Exeter", "Hampton")
north_country <- c("Berlin", "Colebrook", "Lancaster", "Littleton", "Gorham")

enr_regional <- fetch_enr_multi(c(2016, 2018, 2021, 2024), use_cache = TRUE)

regional <- enr_regional %>%
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL") %>%
  mutate(region = case_when(
    grepl(paste(seacoast, collapse = "|"), district_name) ~ "Seacoast",
    grepl(paste(north_country, collapse = "|"), district_name) ~ "North Country",
    TRUE ~ "Other"
  )) %>%
  filter(region %in% c("Seacoast", "North Country")) %>%
  group_by(end_year, region) %>%
  summarize(total = sum(n_students, na.rm = TRUE), .groups = "drop")

regional
```

```{r regional-chart, fig.cap="Regional enrollment trends in New Hampshire"}
ggplot(regional, aes(x = end_year, y = total, color = region)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 3) +
  scale_color_manual(values = c("Seacoast" = "#2E86AB", "North Country" = "#E94F37")) +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "Regional Enrollment: Seacoast vs. North Country",
    subtitle = "North Country experiencing steeper declines than coastal areas",
    x = "Year",
    y = "Students",
    color = "Region"
  ) +
  theme(legend.position = "right")
```

## Grade-Level Trends: The Pipeline Is Narrowing

Kindergarten enrollment trends signal potential future decline, as fewer students enter the system each year.

```{r grade-level-data}
enr_grades <- fetch_enr_multi(2016:2024, use_cache = TRUE)

grades <- enr_grades %>%
  filter(is_state, subgroup == "total_enrollment",
         grade_level %in% c("K", "01", "05", "09", "12")) %>%
  select(end_year, grade_level, n_students) %>%
  mutate(grade_label = case_when(
    grade_level == "K" ~ "Kindergarten",
    grade_level == "01" ~ "1st Grade",
    grade_level == "05" ~ "5th Grade",
    grade_level == "09" ~ "9th Grade",
    grade_level == "12" ~ "12th Grade"
  ))

grades
```

```{r grade-level-chart, fig.cap="Enrollment by grade level over time"}
grades %>%
  mutate(grade_label = factor(grade_label,
                              levels = c("Kindergarten", "1st Grade", "5th Grade",
                                         "9th Grade", "12th Grade"))) %>%
  ggplot(aes(x = end_year, y = n_students, color = grade_label)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  scale_color_brewer(palette = "Set1") +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "New Hampshire Enrollment by Grade Level (2016-2024)",
    subtitle = "Tracking enrollment pipeline across grade levels",
    x = "Year",
    y = "Students",
    color = "Grade"
  ) +
  theme(legend.position = "right")
```

## District Size Distribution: Many Tiny Districts

New Hampshire has 45 districts with fewer than 300 students. Many of these share administration through SAUs (School Administrative Units).

```{r district-size-data}
district_sizes <- enr_2024 %>%
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL") %>%
  mutate(size = case_when(
    n_students >= 3000 ~ "Large (3,000+)",
    n_students >= 1000 ~ "Medium (1,000-2,999)",
    n_students >= 300 ~ "Small (300-999)",
    TRUE ~ "Tiny (<300)"
  )) %>%
  count(size) %>%
  mutate(size = factor(size, levels = c("Tiny (<300)", "Small (300-999)",
                                         "Medium (1,000-2,999)", "Large (3,000+)")))

district_sizes
```

```{r district-size-chart, fig.cap="Distribution of district sizes in New Hampshire"}
ggplot(district_sizes, aes(x = size, y = n, fill = size)) +
  geom_col() +
  geom_text(aes(label = n), vjust = -0.5, size = 4) +
  scale_fill_manual(values = c("Tiny (<300)" = "#E94F37", "Small (300-999)" = "#F6AE2D",
                               "Medium (1,000-2,999)" = "#86BA90", "Large (3,000+)" = "#2E86AB")) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1))) +
  labs(
    title = "New Hampshire Districts by Size (2024)",
    subtitle = "45 tiny districts with fewer than 300 students",
    x = "District Size",
    y = "Number of Districts"
  ) +
  theme(legend.position = "none")
```

## Summary

New Hampshire's public school enrollment tells a story of demographic transition:

- **Declining enrollment**: Gradual decline reflecting aging population
- **Regional divergence**: Coastal areas stable, rural North Country experiencing steeper declines
- **Diversification**: Hispanic and multiracial student populations growing
- **Many small districts**: Districts sharing administration through SAUs

## Session Info

```{r session-info}
sessionInfo()
```
